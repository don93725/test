<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç„™çƒ¤é£Ÿå“ ä¸™ç´šæ¸¬é©—</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #fefaf6;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #ff7e5f;
      text-align: center;
    }
    button {
      background: #ff7e5f;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px 0 0;
      transition: all 0.3s;
    }
    button:hover {
      background: #ff5c3a;
      transform: scale(1.05);
    }
    .correct, .wrong, .ranking-entry {
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    .correct { background: #e0ffe0; border: 1px solid #50d050; }
    .wrong { background: #ffe0e0; border: 1px solid #ff6060; }
    .ranking-entry { background: #fff4f0; display: flex; justify-content: space-between; align-items: center; }
    .first { background: #ffe066; }
    .second { background: #ffcc99; }
    .third { background: #ffb3b3; }
    .progress-bar { width: 100%; background: #ffe6d5; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(to right, #ff9a8b, #ff6a88); transition: width 0.4s; }
  </style>
</head>
<body>
<div class="container">
  <h1>ç„™çƒ¤é£Ÿå“ ä¸™ç´šæ¸¬é©—</h1>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div id="status" style="margin: 10px 0; font-size: 18px; text-align: center;"></div>
  <div id="quiz"></div>
  <button id="nextBtn" onclick="nextQuestion()">é–‹å§‹æ¸¬é©—</button>
  <button onclick="showErrorRanking()">éŒ¯é¡Œæ’è¡Œæ¦œ</button>
  <button onclick="clearErrorData()">æ¸…é™¤éŒ¯é¡Œç´€éŒ„</button>
  <button onclick="startErrorPractice()">éŒ¯é¡Œç·´ç¿’</button>
  <button onclick="startUnansweredPractice()">æœªä½œç­”ç·´ç¿’</button>
  <div class="result" id="result"></div>
  <canvas id="pieChart" width="400" height="400" style="display:none;"></canvas>
</div>
<script>
let questions = [];
let selected = [];
let currentIndex = 0;
let userAnswers = [];
let isErrorPracticeMode = false;
let isUnansweredMode = false;

function pickRandomQuestions(array, count) {
  const picked = [];
  const copy = [...array];
  while (picked.length < count && copy.length > 0) {
    const idx = Math.floor(Math.random() * copy.length);
    picked.push(copy.splice(idx, 1)[0]);
  }
  return picked;
}

async function startQuiz() {
  if (questions.length === 0) {
    const response = await fetch('questions.json');
    questions = await response.json();
  }
  selected = pickRandomQuestions(questions, 10);
  currentIndex = 0; userAnswers = [];
  isErrorPracticeMode = false;
  isUnansweredMode = false;
  document.getElementById("result").innerHTML = "";
  document.getElementById("pieChart").style.display = "none";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  updateStatus();
  showQuestion();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function showQuestion() {
  const quizDiv = document.getElementById("quiz");
  const q = selected[currentIndex];
  document.getElementById("progressFill").style.width = ((currentIndex/selected.length)*100)+"%";
  quizDiv.innerHTML = `<div class="question">(${currentIndex+1}/${selected.length}) ${q.q}</div>
  <div class="difficulty">é›£æ˜“åº¦ï¼š${q.difficulty}</div>
  <div class="options">
    ${q.options.map((opt, i) => `<label><input type='radio' name='option' value='${i}'> ${opt}</label>`).join('')}
  </div>`;
}

function nextQuestion() {
  const selectedOption = document.querySelector("input[name='option']:checked");
  if (!selectedOption) { alert("è«‹å…ˆé¸æ“‡ç­”æ¡ˆ"); return; }
  userAnswers.push(parseInt(selectedOption.value));
  currentIndex++;
  if (currentIndex < selected.length) showQuestion();
  else showResult();
}

function showResult() {
  let correct = 0;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  let correctScore = JSON.parse(localStorage.getItem('perfectScoreCount')) || 0;
  let resultHTML = "";
  selected.forEach((q, idx) => {
    const isCorrect = userAnswers[idx] === q.answer;
    if (!isCorrect) { errorData[q.q] = (errorData[q.q]||0)+1; }
    if (isCorrect) {
      correct++;
      resultHTML += `<div class='correct'><p>ç¬¬ ${idx + 1} é¡Œ ç­”å°ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    } else {
      resultHTML += `<div class='wrong'><p>ç¬¬ ${idx + 1} é¡Œ éŒ¯èª¤ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    }
  });
  if (correct === selected.length) {
    correctScore++;
    localStorage.setItem('perfectScoreCount', correctScore);
    alert('ğŸ‰ æ­å–œï¼å®Œç¾é€šéï¼');
  } else {
    localStorage.setItem('perfectScoreCount', correctScore);
  }
  localStorage.setItem('errorCount', JSON.stringify(errorData));
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("result").innerHTML = `<h2>ä½œç­”å®Œæˆï¼ç­”å° ${correct}/${selected.length} é¡Œ</h2><h3>å®Œç¾é€šéæ¬¡æ•¸ï¼š${correctScore} æ¬¡</h3>` + resultHTML;
  document.getElementById("nextBtn").innerText = "é‡æ–°æ¸¬é©—";
  document.getElementById("nextBtn").onclick = () => {
    isUnansweredMode = false;
    startQuiz();
  };
  updateStatus();
  drawPie(correct, selected.length-correct);
}

function drawPie(correct, wrong) {
  document.getElementById("pieChart").style.display = "block";
  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: ['ç­”å°', 'ç­”éŒ¯'],
      datasets: [{ data: [correct, wrong], backgroundColor: ['#a0e7a0', '#ff9999'] }]
    },
    options: { responsive: true, plugins: {legend:{position:'bottom'}} }
  });
}

function showErrorRanking() {
  const errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]);
  if (errorArray.length==0) { document.getElementById("result").innerHTML = "<h2>ç›®å‰ç„¡éŒ¯é¡Œç´€éŒ„ï¼</h2>"; return; }
  const html = errorArray.map(([qText, count], i) => {
    const question = questions.find(q => q.q === qText);
    const correctAns = question ? question.options[question.answer] : '(æ‰¾ä¸åˆ°æ­£ç¢ºç­”æ¡ˆ)';
    const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : '';
    return `<div class='ranking-entry ${i===0?'first':i===1?'second':i===2?'third':''}'>
      <div>${medal} ${qText}<br>æ­£ç¢ºç­”æ¡ˆï¼š${correctAns}</div>
      <div style='font-size:20px;'>${count}</div>
    </div>`;
  }).join('');
  document.getElementById("result").innerHTML = `<h2>éŒ¯é¡Œæ’è¡Œæ¦œ</h2>${html}`;
}

function clearErrorData() {
  if (confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰éŒ¯é¡Œç´€éŒ„ï¼Ÿ")) {
    localStorage.removeItem('errorCount');
    alert("éŒ¯é¡Œç´€éŒ„å·²æ¸…é™¤ï¼");
    document.getElementById("result").innerHTML = "<h2>éŒ¯é¡Œç´€éŒ„å·²æ¸…é™¤ï¼</h2>";
  }
}

function startErrorPractice() {
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topQuestions = errorArray.map(([q])=>q);
  if (topQuestions.length==0) { alert('ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯ä»¥ç·´ç¿’ï¼'); return; }
  selected = questions.filter(q => topQuestions.includes(q.q));
  shuffle(selected);
  currentIndex = 0; userAnswers = []; isErrorPracticeMode = true;
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  updateStatus();
  showQuestion();
}

function startUnansweredPractice() {
  isUnansweredMode = true;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  selected = questions.filter(q => !(q.q in errorData));
  if (selected.length === 0) {
    alert("ç›®å‰æ‰€æœ‰é¡Œç›®éƒ½å·²ç¶“ä½œç­”éå›‰ï¼");
    return;
  }
  shuffle(selected);
  currentIndex = 0; userAnswers = [];
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  updateStatus();
  showQuestion();
}

function updateStatus() {
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  let correctScore = JSON.parse(localStorage.getItem('perfectScoreCount')) || 0;
  let unansweredCount = questions.filter(q => !(q.q in errorData)).length;
  const statusDiv = document.getElementById("status");
  if (statusDiv) {
    statusDiv.innerHTML = `æœªä½œç­”é¡Œç›®æ•¸é‡ï¼š${unansweredCount} / å®Œç¾é€šé—œæ¬¡æ•¸ï¼š${correctScore}`;
  }
}

startQuiz();
</script>
</body>
</html>
