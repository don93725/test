<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>焙烤食品 丙級測驗</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #fefaf6;
    color: #333;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  h1 {
    color: #ff7e5f;
    text-align: center;
  }
  .question {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .difficulty {
    font-size: 14px;
    color: gray;
    margin-bottom: 20px;
  }
  .options label {
    display: block;
    background: #fff0e6;
    border: 2px solid #ffc2b3;
    padding: 12px;
    border-radius: 10px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
  }
  .options label:hover {
    background: #ffe6d5;
    transform: scale(1.02);
  }
  button {
    background: #ff7e5f;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px 5px 0 0;
    transition: all 0.3s;
  }
  button:hover {
    background: #ff5c3a;
    transform: scale(1.05);
  }
  .correct { background: #e0ffe0; border: 1px solid #50d050; padding: 15px; border-radius: 10px; margin-top: 15px; }
  .wrong { background: #ffe0e0; border: 1px solid #ff6060; padding: 15px; border-radius: 10px; margin-top: 15px; }
  .result { margin-top: 30px; }
  .progress-bar {
    width: 100%;
    background: #ffe6d5;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(to right, #ff9a8b, #ff6a88);
    transition: width 0.4s;
  }
</style>
</head>
<body>
<div class="container">
  <h1>焙烤食品 丙級測驗</h1>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div id="quiz"></div>
  <button id="nextBtn" onclick="nextQuestion()">開始測驗</button>
  <button onclick="showErrorRanking()">錯題排行榜</button>
  <button onclick="clearErrorData()">清除錯題紀錄</button>
  <button onclick="startErrorPractice()">錯題練習</button>
  <div class="result" id="result"></div>
  <canvas id="pieChart" width="400" height="400" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let questions = [];
let selected = [];
let currentIndex = 0;
let userAnswers = [];
let isErrorPracticeMode = false;

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

async function startQuiz() {
  if (questions.length === 0) {
    const response = await fetch('questions.json');
    questions = await response.json();
  }
  const easy = questions.filter(q => q.difficulty === 'easy');
  const medium = questions.filter(q => q.difficulty === 'medium');
  const hard = questions.filter(q => q.difficulty === 'hard');
  if (easy.length < 3 || medium.length < 3 || hard.length < 4) {
    alert('題庫數量不足！'); return;
  }
  shuffle(easy); shuffle(medium); shuffle(hard);
  selected = [...easy.slice(0,3), ...medium.slice(0,3), ...hard.slice(0,4)];
  shuffle(selected);
  currentIndex = 0; userAnswers = [];
  isErrorPracticeMode = false;
  document.getElementById("result").innerHTML = "";
  document.getElementById("pieChart").style.display = "none";
  document.getElementById("nextBtn").innerText = "下一題";
  showQuestion();
}

function showQuestion() {
  const quizDiv = document.getElementById("quiz");
  const q = selected[currentIndex];
  document.getElementById("progressFill").style.width = ((currentIndex/selected.length)*100)+"%";
  quizDiv.innerHTML = `<div class="question">(${currentIndex+1}/${selected.length}) ${q.q}</div>
  <div class="difficulty">難易度：${q.difficulty}</div>
  <div class="options">
    ${q.options.map((opt, i) => `<label><input type='radio' name='option' value='${i}'> ${opt}</label>`).join('')}
  </div>`;
}

function nextQuestion() {
  const selectedOption = document.querySelector("input[name='option']:checked");
  if (!selectedOption) { alert("請先選擇答案"); return; }
  userAnswers.push(parseInt(selectedOption.value));
  currentIndex++;
  if (currentIndex < selected.length) showQuestion();
  else showResult();
}

function showResult() {
  let correct = 0;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  let resultHTML = "";
  selected.forEach((q, idx) => {
    const isCorrect = userAnswers[idx] === q.answer;
    if (!isCorrect) { errorData[q.q] = (errorData[q.q]||0)+1; }
    if (isCorrect) {
      correct++;
      resultHTML += `<div class='correct'><p>第${idx+1}題 答對</p><p>${q.q}</p></div>`;
    } else {
      let hint = errorData[q.q]>=5 ? "<p style='color:red;'>⚡ 此題已錯 ${errorData[q.q]} 次，加強練習！</p>" : "<p>別氣餒，再試一次！</p>";
      resultHTML += `<div class='wrong'><p>第${idx+1}題 錯誤</p><p>${q.q}</p>${hint}</div>`;
    }
  });
  localStorage.setItem('errorCount', JSON.stringify(errorData));
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("result").innerHTML = `<h2>作答完成！答對 ${correct}/${selected.length} 題</h2>` + resultHTML;
  document.getElementById("nextBtn").innerText = "重新測驗";
  document.getElementById("nextBtn").onclick = startQuiz;
  drawPie(correct, selected.length-correct);
}

function drawPie(correct, wrong) {
  document.getElementById("pieChart").style.display = "block";
  new Chart(document.getElementById('pieChart'), {
    type: 'pie',
    data: {
      labels: ['答對', '答錯'],
      datasets: [{ data: [correct, wrong], backgroundColor: ['#a0e7a0', '#ff9999'] }]
    },
    options: { responsive: true, plugins: {legend:{position:'bottom'}} }
  });
}

function showErrorRanking() {
  const errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]);
  if (errorArray.length==0) { document.getElementById("result").innerHTML = "<h2>目前無錯題紀錄！</h2>"; return; }
  document.getElementById("result").innerHTML = `<h2>錯題排行榜</h2>${errorArray.map(([q,c],i)=>`<p>${i+1}. ${q}（錯${c}次）</p>`).join('')}`;
}

function clearErrorData() {
  if (confirm("確定清除所有錯題紀錄？")) {
    localStorage.removeItem('errorCount');
    alert("錯題紀錄已清除");
    document.getElementById("result").innerHTML = "<h2>錯題紀錄已清除！</h2>";
  }
}

async function startErrorPractice() {
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topQuestions = errorArray.map(([q])=>q);
  if (topQuestions.length==0) { alert('目前沒有錯題可以練習！'); return; }
  selected = questions.filter(q => topQuestions.includes(q.q));
  shuffle(selected);
  currentIndex = 0; userAnswers = []; isErrorPracticeMode = true;
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").innerText = "下一題";
  showQuestion();
}

startQuiz();
</script>

</body>
</html>
