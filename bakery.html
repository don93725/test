<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ç„™çƒ¤é£Ÿå“ ä¸™ç´šæ¸¬é©—</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js">
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #fefaf6;
    color: #333;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  h1 {
    color: #ff7e5f;
    text-align: center;
  }
  .question {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .difficulty {
    font-size: 14px;
    color: gray;
    margin-bottom: 20px;
  }
  .options label {
    display: block;
    background: #fff0e6;
    border: 2px solid #ffc2b3;
    padding: 12px;
    border-radius: 10px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s;
  }
  .options label:hover {
    background: #ffe6d5;
    transform: scale(1.02);
  }
  button {
    background: #ff7e5f;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px 5px 0 0;
    transition: all 0.3s;
  }
  button:hover {
    background: #ff5c3a;
    transform: scale(1.05);
  }
  .correct { background: #e0ffe0; border: 1px solid #50d050; padding: 15px; border-radius: 10px; margin-top: 15px; }
  .wrong { background: #ffe0e0; border: 1px solid #ff6060; padding: 15px; border-radius: 10px; margin-top: 15px; }
  .ranking-entry { background: #fff4f0; padding: 12px; border-radius: 8px; margin: 8px 0; }
  .first { background: #ffe066; font-weight: bold; }
  .second { background: #ffcc99; }
  .third { background: #ffb3b3; }
  .result { margin-top: 30px; }
  .progress-bar {
    width: 100%;
    background: #ffe6d5;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(to right, #ff9a8b, #ff6a88);
    transition: width 0.4s;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ç„™çƒ¤é£Ÿå“ ä¸™ç´šæ¸¬é©—</h1>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div id="quiz"></div>
  <button id="nextBtn" onclick="nextQuestion()">é–‹å§‹æ¸¬é©—</button>
  <button onclick="showErrorRanking()">éŒ¯é¡Œæ’è¡Œæ¦œ</button>
  <button onclick="clearErrorData()">æ¸…é™¤éŒ¯é¡Œç´€éŒ„</button>
  <button onclick="startErrorPractice()">éŒ¯é¡Œç·´ç¿’</button>
  <button onclick="startUnansweredPractice()">æœªä½œç­”ç·´ç¿’</button>
  <div class="result" id="result"></div>
  <canvas id="pieChart" width="400" height="400" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let questions = [];
let selected = [];
let currentIndex = 0;
let userAnswers = [];
let isErrorPracticeMode = false;
let isUnansweredMode = false;

function pickRandomQuestions(array, count) {
  const picked = [];
  const copy = [...array];
  while (picked.length < count && copy.length > 0) {
    const idx = Math.floor(Math.random() * copy.length);
    picked.push(copy.splice(idx, 1)[0]);
  }
  return picked;
}

async function startQuiz() {
  if (questions.length === 0) {
    const response = await fetch('questions.json');
    questions = await response.json();
  }
  selected = pickRandomQuestions(questions, 10);
  currentIndex = 0; userAnswers = [];
  isErrorPracticeMode = false;
  isUnansweredMode = false;
  document.getElementById("result").innerHTML = "";
  document.getElementById("pieChart").style.display = "none";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  showQuestion();
}

function showErrorRanking() {
  const errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]);
  if (errorArray.length==0) { document.getElementById("result").innerHTML = "<h2>ç›®å‰ç„¡éŒ¯é¡Œç´€éŒ„ï¼</h2>"; return; }
  const html = errorArray.map(([qText, count], i) => {
    const question = questions.find(q => q.q === qText);
    const correctAns = question ? question.options[question.answer] : '(æ‰¾ä¸åˆ°æ­£ç¢ºç­”æ¡ˆ)';
    return `<div class='ranking-entry ${i===0?'first':i===1?'second':i===2?'third':''}'>
      ${i+1}ä½ğŸ† ${qText}<br>
      éŒ¯èª¤æ¬¡æ•¸ï¼š${count}<br>
      æ­£ç¢ºç­”æ¡ˆï¼š${correctAns}
    </div>`;
  }).join('');
  document.getElementById("result").innerHTML = `<h2>éŒ¯é¡Œæ’è¡Œæ¦œ</h2>${html}`;
}

function startUnansweredPractice() {
  isUnansweredMode = true;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  selected = questions.filter(q => !(q.q in errorData));
  if (selected.length === 0) {
    alert("ç›®å‰æ‰€æœ‰é¡Œç›®éƒ½å·²ç¶“ä½œç­”éå›‰ï¼");
    return;
  }
  shuffle(selected);
  currentIndex = 0; userAnswers = []; 
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  showQuestion();
}

function showResult() {
  let correct = 0;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  let correctScore = JSON.parse(localStorage.getItem('perfectScoreCount')) || 0;
  let resultHTML = "";
  selected.forEach((q, idx) => {
    const isCorrect = userAnswers[idx] === q.answer;
    if (!isCorrect) { errorData[q.q] = (errorData[q.q]||0)+1; }
    if (isCorrect) {
      correct++;
      resultHTML += `<div class='correct'><p>ç¬¬ ${idx + 1} é¡Œ ç­”å°ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    } else {
      resultHTML += `<div class='wrong'><p>ç¬¬ ${idx + 1} é¡Œ éŒ¯èª¤ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    }
  });
  if (correct === selected.length) {
    correctScore++;
    localStorage.setItem('perfectScoreCount', correctScore);
    alert('ğŸ‰ æ­å–œï¼å®Œç¾é€šéï¼');
  } else {
    localStorage.setItem('perfectScoreCount', correctScore);
  }
  localStorage.setItem('errorCount', JSON.stringify(errorData));
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("result").innerHTML = `<h2>ä½œç­”å®Œæˆï¼ç­”å° ${correct}/${selected.length} é¡Œ</h2><h3>å®Œç¾é€šéæ¬¡æ•¸ï¼š${correctScore} æ¬¡</h3>` + resultHTML;
  document.getElementById("nextBtn").innerText = "é‡æ–°æ¸¬é©—";
  document.getElementById("nextBtn").onclick = () => {
    isUnansweredMode = false;
    startQuiz();
  };
  drawPie(correct, selected.length-correct);
}
</script>
</body>
</html>
