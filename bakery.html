<script>
let questions = [];
let selected = [];
let currentIndex = 0;
let userAnswers = [];
let isErrorPracticeMode = false;
let isUnansweredMode = false;

function pickRandomQuestions(array, count) {
  const picked = [];
  const copy = [...array];
  while (picked.length < count && copy.length > 0) {
    const idx = Math.floor(Math.random() * copy.length);
    picked.push(copy.splice(idx, 1)[0]);
  }
  return picked;
}

async function startQuiz() {
  if (questions.length === 0) {
    const response = await fetch('questions.json');
    questions = await response.json();
  }
  selected = pickRandomQuestions(questions, 10);
  currentIndex = 0; userAnswers = [];
  isErrorPracticeMode = false;
  isUnansweredMode = false;
  document.getElementById("result").innerHTML = "";
  document.getElementById("pieChart").style.display = "none";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  showQuestion();
}

function showErrorRanking() {
  const errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  const errorArray = Object.entries(errorData).sort((a,b)=>b[1]-a[1]);
  if (errorArray.length==0) { document.getElementById("result").innerHTML = "<h2>ç›®å‰ç„¡éŒ¯é¡Œç´€éŒ„ï¼</h2>"; return; }
  const html = errorArray.map(([qText, count], i) => {
    const question = questions.find(q => q.q === qText);
    const correctAns = question ? question.options[question.answer] : '(æ‰¾ä¸åˆ°æ­£ç¢ºç­”æ¡ˆ)';
    return `<div class='ranking-entry ${i===0?'first':i===1?'second':i===2?'third':''}'>
      ${i+1}ä½ğŸ† ${qText}<br>
      éŒ¯èª¤æ¬¡æ•¸ï¼š${count}<br>
      æ­£ç¢ºç­”æ¡ˆï¼š${correctAns}
    </div>`;
  }).join('');
  document.getElementById("result").innerHTML = `<h2>éŒ¯é¡Œæ’è¡Œæ¦œ</h2>${html}`;
}

function startUnansweredPractice() {
  isUnansweredMode = true;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  selected = questions.filter(q => !(q.q in errorData));
  if (selected.length === 0) {
    alert("ç›®å‰æ‰€æœ‰é¡Œç›®éƒ½å·²ç¶“ä½œç­”éå›‰ï¼");
    return;
  }
  shuffle(selected);
  currentIndex = 0; userAnswers = []; 
  document.getElementById("result").innerHTML = "";
  document.getElementById("nextBtn").innerText = "ä¸‹ä¸€é¡Œ";
  document.getElementById("nextBtn").onclick = nextQuestion;
  showQuestion();
}

function showResult() {
  let correct = 0;
  let errorData = JSON.parse(localStorage.getItem('errorCount')) || {};
  let correctScore = JSON.parse(localStorage.getItem('perfectScoreCount')) || 0;
  let resultHTML = "";
  selected.forEach((q, idx) => {
    const isCorrect = userAnswers[idx] === q.answer;
    if (!isCorrect) { errorData[q.q] = (errorData[q.q]||0)+1; }
    if (isCorrect) {
      correct++;
      resultHTML += `<div class='correct'><p>ç¬¬ ${idx + 1} é¡Œ ç­”å°ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    } else {
      resultHTML += `<div class='wrong'><p>ç¬¬ ${idx + 1} é¡Œ éŒ¯èª¤ï¼</p><p>é¡Œç›®ï¼š${q.q}</p></div>`;
    }
  });
  if (correct === selected.length) {
    correctScore++;
    localStorage.setItem('perfectScoreCount', correctScore);
    alert('ğŸ‰ æ­å–œï¼å®Œç¾é€šéï¼');
  } else {
    localStorage.setItem('perfectScoreCount', correctScore);
  }
  localStorage.setItem('errorCount', JSON.stringify(errorData));
  document.getElementById("quiz").innerHTML = "";
  document.getElementById("progressFill").style.width = "100%";
  document.getElementById("result").innerHTML = `<h2>ä½œç­”å®Œæˆï¼ç­”å° ${correct}/${selected.length} é¡Œ</h2><h3>å®Œç¾é€šéæ¬¡æ•¸ï¼š${correctScore} æ¬¡</h3>` + resultHTML;
  document.getElementById("nextBtn").innerText = "é‡æ–°æ¸¬é©—";
  document.getElementById("nextBtn").onclick = () => {
    isUnansweredMode = false;
    startQuiz();
  };
  drawPie(correct, selected.length-correct);
}
</script>
